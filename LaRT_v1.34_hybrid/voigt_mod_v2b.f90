module voigt_mod
  public voigt
  private
  interface voigt
     ! 1) voigt_AQ1 is the most accurate routine, but 1.4-1.7 times slower than voit_king.
     ! 2) do not use voigt_gnedin if one wants to calculate the intensity spectrum inside medium.
     !    But, it might be okay if only number of scattering is calculated? (need to be confirmed.)
     !    voigt_gnedin is sligtly faster than voigt_king (about 0.9-1.0 times faster than voigt_king).
     ! accuracy - voigt_AQ1,    voigt_AQ2,  voigt_king, voigt_gnedin
     ! speed    - voigt_gnedin, voigt_king, voigt_AQ2,  voigt_AQ1
     ! 3) voigt_seon2 is very accurate, but still very fast.
     module procedure voigt_seon2
     !module procedure voigt_king
     !module procedure voigt_AQ2
     !module procedure voigt_AQ1
  end interface voigt
contains
! voigt profile
!
! vin = x = (nu - nu0)/Doppler frequency width
! a   = Voigt parameter (A21/4pi/Doppler freqency width)
!       A21 = damping constant
!
! Adopted from VPFIT package (https://www.ast.cam.ac.uk/~rfc/vpfit.html)
!    The Voigt function error is < 10^-5.
!    2010/09/15 K.I. Seon
!    2016/10/25 modified into fortran 90 format
!    2019/12/10 slightly modified, cosmetic changes
!
   function voigt_king(vin,a) result(voigt)
   use define, only : wp
   implicit none
   real(kind=wp), intent(in) :: a,vin
   real(kind=wp) :: voigt
!
   real(kind=wp) :: v, v0, v2
!     real(kind=wp) :: v1
   integer       :: n,p,p1,p2
   real(kind=wp) :: x,y,z
   real(kind=wp) :: oneonsqrtpi=0.56418958354775630d0
!     real(kind=wp) :: sqrtpi=1.772453850906d0
   real(kind=wp) :: r
   !---------------------
   real(kind=wp), parameter :: h0(202) = [&
        1.0d0, .9975031223974601240368798d0, .9900498337491680535739060d0, &
        .9777512371933363639286036d0, .9607894391523232094392107d0, .9394130628134757861197108d0, &
        .9139311852712281867473535d0, .8847059049434835594929548d0, .8521437889662113384563470d0, &
        .8166864825981108401538061d0, .7788007830714048682451703d0, .7389684882589442416058206d0, &
        .6976763260710310572091293d0, .6554062543268405127576690d0, .6126263941844160689885800d0, &
        .5697828247309230097666297d0, .5272924240430485572436946d0, .4855368951540794399916001d0, &
        .4448580662229411344814454d0, .4055545050633205516443034d0, .3678794411714423215955238d0, &
        .3320399453446606420249195d0, .2981972794298873779316010d0, .2664682978135241116965901d0, &
        .2369277586821217567233665d0, .2096113871510978225241101d0, .1845195239929892676298138d0, &
        .1616211924653392539324509d0, .1408584209210449961479715d0, .1221506695399900084151679d0, &
        .1053992245618643367832177d0, .9049144166369591062935159d-1, .7730474044329974599046566d-1, &
        .6571027322750286139200605d-1, .5557621261148306865356766d-1, .4677062238395898365276137d-1, &
        .3916389509898707373977109d-1, .3263075599289603180381419d-1, .2705184686635041108596167d-1, &
        .2231491477696640649487920d-1, .1831563888873418029371802d-1, .1495813470057748930092482d-1, &
        .1215517832991493721502629d-1, .9828194835379685936011149d-2, .7907054051593440493635646d-2, &
        .6329715427485746576865117d-2, .5041760259690979102410257d-2, .3995845830084632413030896d-2, &
        .3151111598444440557819106d-2, .2472563035874193226953048d-2, .1930454136227709242213512d-2, &
        .1499685289329846120368399d-2, .1159229173904591150012118d-2, .8915937199952195568639939d-3, &
        .6823280527563766163014506d-3, .5195746821548384817648154d-3, .3936690406550782109805393d-3, &
        .2967857677932108344855019d-3, .2226298569188890101840659d-3, .1661698666072774484528398d-3, &
        .1234098040866795494976367d-3, .9119595636226606575873788d-4, .6705482430281108867614262d-4, &
        .4905835745620769579106241d-4, .3571284964163521691234528d-4, .2586810022265412127035909d-4, &
        .1864374233151683041526522d-4, .1336996212084380475632834d-4, .9540162873079234841590110d-5, &
        .6773449997703748098370991d-5, .4785117392129009089609771d-5, .3363595724825637829225185d-5, &
        .2352575200009772922652510d-5, .1637237807196195233271403d-5, .1133727138747965652009438d-5, &
        .7811489408304490795473004d-6, .5355347802793106157479094d-6, .3653171341207511214363159d-6, &
        .2479596018045029629499234d-6, .1674635703137489046698250d-6, .1125351747192591145137752d-6, &
        .7524623257644829651017174d-7, .5006218020767042215644986d-7, .3314082270898834287088712d-7, &
        .2182957795125479209083827d-7, .1430724191856768833467676d-7, .9330287574504991120387842d-8, &
        .6054282282484886644264747d-8, .3908938434264861859681131d-8, .2511212833271291589987176d-8, &
        .1605228055185611608653934d-8, .1020982947159334870301705d-8, .6461431773106108989429857d-9, &
        .4068811450655793356678124d-9, .2549381880391968872012880d-9, .1589391009451636652873474d-9, &
        .9859505575991508240729766d-10, .6085665105518337082108266d-10, .3737571327944262032923964d-10, &
        .2284017657993705413027994d-10, .1388794386496402059466176d-10, .8402431396484308187150245d-11, &
        .5058252742843793235026422d-11, .3029874246723653849216172d-11, .1805831437513215621913785d-11, &
        .1070923238250807645586450d-11, .6319285885175366663984108d-12, .3710275783094727281418983d-12, &
        .2167568882618961942307398d-12, .1259993054847742150188394d-12, .7287724095819692419343177d-13, &
        .4194152536192217185131208d-13, .2401734781620959445230543d-13, .1368467228126496785536523d-13, &
        .7758402075696070467242451d-14, .4376618502870849893821267d-14, .2456595368792144453705261d-14, &
        .1372009419645128473380053d-14, .7624459905389739760616425d-15, .4215893238174252040735029d-15, &
        .2319522830243569388312264d-15, .1269802641377875575018264d-15, .6916753975541448863883054d-16, &
        .3748840457745443581785685d-16, .2021715848695342027119482d-16, .1084855264042937802512215d-16, &
        .5792312885394857923477507d-17, .3077235638152508657901574d-17, .1626664621453244338034305d-17, &
        .8555862896902856300749061d-18, .4477732441718301199042103d-18, .2331744656246116743545942d-18, &
        .1208182019899973571654094d-18, .6228913128535643653088166d-19, .3195366717748344275120932d-19, &
        .1631013922670185678641901d-19, .8283677007682876110228791d-20, .4186173006145967657832773d-20, &
        .2104939978339734445589080d-20, .1053151347744013743766989d-20, .5242885663363463937171805d-21, &
        .2597039249246848208769072d-21, .1280015319051641983953037d-21, .6277407889747195099574399d-22, &
        .3063190864577440373821128d-22, .1487292181651270619154227d-22, .7185335635902193010046941d-23, &
        .3454031957013868448981675d-23, .1652091782314268593068387d-23, .7862678502984538622254116d-24, &
        .3723363121750510429289070d-24, .1754400713566556605465117d-24, .8225280651606668501925640d-25, &
        .3837082905344536379879530d-25, .1781066634757091357021587d-25, .8225980595143903024275237d-26, &
        .3780277844776084635218009d-26, .1728575244037268289032505d-26, .7864685935766448441713277d-27, &
        .3560434556451067378310069d-27, .1603810890548637852976087d-27, .7188393394953158727447087d-28, &
        .3205819323394999444158648d-28, .1422573701362478490703169d-28, .6281148147605989215436687d-29, &
        .2759509067522042024589005d-29, .1206293927781149203841840d-29, .5246902396795390138796640d-30, &
        .2270812922026396509517690d-30, .9778860615814667663870901d-31, .4190093194494397377123780d-31, &
        .1786436718517518413888050d-31, .7578445267618382646037748d-32, .3198903416725805416294188d-32, &
        .1343540197758737662452134d-32, .5614728092387934579799402d-33, .2334722783487267408869808d-33, &
        .9659851300583384710233199d-34, .3976803097901655265751816d-34, .1629019426220514693169818d-34, &
        .6639677199580734400702255d-35, .2692751000456178970430831d-35, .1086610640745980532852592d-35, &
        .4362950029268711046345153d-36, .1743070896645292498913954d-36, .6929124938815710000577778d-37, &
        .2740755284722598699701951d-37, .1078675105373929991550997d-37, .4224152406206200437573993d-38, &
        .1645951484063258284098658d-38, .6381503448060790393554118d-39, .2461826907787885454919214d-39, &
        .9449754976491185028813549d-40, .3609209642415355020302235d-40, .1371614910949353618952282d-40, &
        .5186576811908572940413120d-41, .1951452380295377748121319d-41, .7305730197111493885868359d-42, &
        .2721434140093713884466599d-42, .1008696596314342558322441d-42, .3720075976020835962959696d-43, &
        .1365122395620087240477630d-43]

   real(kind=wp), parameter :: h1(202) = [&
        -1.128379167095512573896159d0, -1.122746665023313894112994d0, -1.105961434222613497822717d0, &
        -1.078356949458362356972974d0, -1.040477963566390226869037d0, -.9930644092865188274925694d0, &
        -.9370297574325730524254160d0, -.8734346738611667009559691d0, -.8034569860177944012914767d0, &
        -.7283590897795191457635390d0, -.6494539941944691013512214d0, -.5680712138345335512208471d0, &
        -.4855236771153186839197872d0, -.4030767281964792012404736d0, -.3219201665209207840831093d0, &
        -.2431441002236951675148354d0, -.1677191974661332963609891d0, -.9648171389061105293546881d-1, &
        -.3012346558870770535102483d-1, .3081328457047809980986685d-1, .8593624458727488433391777d-1, &
        .1349991935349749351748713d0, .1778942744880748462232135d0, .2146410885736963723412265d0, &
        .2453732617833523433216744d0, .2703231847626659615037426d0, .2898056218155761132507312d0, &
        .3042008523837261147222841d0, .3139379509747736418513567d0, .3194787353320834397089635d0, &
        .3213028233267945998845488d0, .3198941423604233541674753d0, .3157291364070343763776039d0, &
        .3092668200208504802085382d0, .3009407397271468294117335d0, .2911528243392948676821857d0, &
        .2802690390913659378360681d0, .2686167052981096351368975d0, .2564833079412283848897372d0, &
        .2441165877658165024921633d0, .2317257011687522312257119d0, .2194832289213470945135105d0, &
        .2075278218310246553881156d0, .1959672858880207128215797d0, .1848819293094190730287360d0, &
        .1743280173110208640535652d0, .1643412057011470302647273d0, .1549398500207542791790132d0, &
        .1461281117364874603340094d0, .1378988059908943461128856d0, .1302359559637753421977543d0, &
        .1231170365911391556632533d0, .1165149050377156668055896d0, .1103994269264874144398788d0, &
        .1047388160423518894772002d0, .9950071130235648759030670d-1, .9465301854781620910441970d-1, &
        .9016454652735125189272609d-1, .8600546667768981700419079d-1, .8214762533231104047151097d-1, &
        .7856473513008974607178765d-1, .7523246995193424459351750d-1, .7212848493340500348466924d-1, &
        .6923238018945846374255513d-1, .6652562400245432725286132d-1, .6399144848312167544450556d-1, &
        .6161472819590847810012464d-1, .5938184999317344054777048d-1, .5728058034957269600588669d-1, &
        .5529993483145627029203620d-1, .5343005296426139233134751d-1, .5166208065197234887486323d-1, &
        .4998806142885727821214551d-1, .4840083715410895783485349d-1, .4689395826338997495993764d-1, &
        .4546160333748704598916335d-1, .4409850750954268216573793d-1, .4279989908392569899980027d-1, &
        .4156144366035708515282858d-1, .4037919502845779134315796d-1, .3924955210570969222557380d-1, &
        .3816922122416471946490538d-1, .3713518311895684989765586d-1, .3614466402785612590311943d-1, &
        .3519511037069617482332004d-1, .3428416653694949866994660d-1, .3340965536664229903158673d-1, &
        .3256956096272257612903376d-1, .3176201352112533673779090d-1, .3098527590780517228496903d-1, &
        .3023773174995156695256252d-1, .2951787484170619418302355d-1, .2882429969333463230632146d-1, &
        .2815569307740452259166926d-1, .2751082644654734935368337d-1, .2688854911528297388431485d-1, &
        .2628778211358937241904422d-1, .2570751263279204975253415d-1, .2514678899527364475073049d-1, &
        .2460471608876676259183765d-1, .2408045121385331090696902d-1, .2357320029997478838776359d-1, &
        .2308221445094914570064896d-1, .2260678678585010840991674d-1, .2214624954526743636682309d-1, &
        .2169997143654264861646818d-1, .2126735519465680897241377d-1, .2084783533811200664569883d-1, &
        .2044087610146017752978434d-1, .2004596952814515567227767d-1, .1966263370908071277476715d-1, &
        .1929041115392591487587378d-1, .1892886728337045173071115d-1, .1857758903193275942486415d-1, &
        .1823618355182474294515453d-1, .1790427700936730343669473d-1, .1758151346626646308038721d-1, &
        .1726755383879409857500321d-1, .1696207492857163038741910d-1, .1666476851923932358834102d-1, &
        .1637534053381661837450139d-1, .1609351024802744708797459d-1, .1581900955528515170398058d-1, &
        .1555158227940989996039230d-1, .1529098353149220739767610d-1, .1503697910762349625920090d-1, &
        .1478934492449222808347731d-1, .1454786649009525295887101d-1, .1431233840704145462214254d-1, &
        .1408256390613103046576229d-1, .1385835440808103075999097d-1, .1363952911143803959964144d-1, &
        .1342591460487383719630737d-1, .1321734450220107129175951d-1, .1301365909857474699723209d-1, &
        .1281470504646293252049926d-1, .1262033505007755515762735d-1, .1243040757705449418533892d-1, &
        .1224478658626222948827240d-1, .1206334127070085131071308d-1, .1188594581452897199141430d-1, &
        .1171247916332562864755594d-1, .1154282480675818732553606d-1, .1137687057288605896976939d-1, &
        .1121450843338417065773542d-1, .1105563431902001242285305d-1, .1090014794476407143162512d-1, &
        .1074795264395590657657700d-1, .1059895521098731117021612d-1, .1045306575200023435008377d-1, &
        .1031019754313063242129945d-1, .1017026689586042607609242d-1, .1003319302906845397201302d-1, &
        .9898897947397924639729408d-2, .9767306325582547468180475d-2, .9638345398396424782187982d-2, &
        .9511944855914052317394595d-2, .9388036743786533882143785d-2, .9266555368258485665416943d-2, &
        .9147437205667194364984339d-2, .9030620816181499749829423d-2, .8916046761552686783940876d-2, &
        .8803657526663477808232965d-2, .8693397444674087410976982d-2, .8585212625576311168220303d-2, &
        .8479050887977828363904268d-2, .8374861693949366877024963d-2, .8272596086777159693185345d-2, &
        .8172206631472266686907249d-2, .8073647357896888215194357d-2, .7976873706375800846399120d-2, &
        .7881842475668539112571351d-2, .7788511773184966394916599d-2, .7696840967333456047851643d-2, &
        .7606790641897071224649652d-2, .7518322552338916854888971d-2, .7431399583943265980411531d-2, &
        .7345985711704159367477213d-2, .7262045961877964368036759d-2, .7179546375120877141317720d-2, &
        .7098453971136580788416864d-2, .7018736714763248519923831d-2, .6940363483432822204243367d-2, &
        .6863304035939017881037086d-2, .6787528982453825324020280d-2, .6713009755735391745310971d-2, &
        .6639718583473122562606414d-2, .6567628461718606252976457d-2, .6496713129353586350126915d-2, &
        .6426947043548671526978323d-2, .6358305356168803683625031d-2, .6290763891083702643557758d-2, &
        .6224299122343582476647260d-2, .6158888153182396103862750d-2, .6094508695812718682782931d-2, &
        .6031139051978132847456608d-2, .5968758094230636272231571d-2, .5907345247902159938278185d-2, &
        .5846880473740769223255677d-2, .5787344251183524483318654d-2, .5728717562239307805652498d-2, &
        .5670981875956182433959706d-2]

   real(kind=wp), parameter :: h2(202) = [&
        1.0d0, .9925156067854728234166954d0, .9702488370741846925024279d0, &
        .9337524315196362275518164d0, .8839262840201373526840738d0, .8219864299617913128547470d0, &
        .7494235719224071131328299d0, .6679529582323300874171809d0, .5794577764970237101503160d0, &
        .4859284571458759498915146d0, .3894003915357024341225852d0, .2918925528622829754342991d0, &
        .1953493712998886960185562d0, .1015879694206602794774387d0, .1225252788368832137977160d-1, &
        -.7122285309136537622082871d-1, -.1476418787320535960282345d0, -.2160639183435653507962620d0, &
        -.2758120010582235033784961d0, -.3264713765759730440736642d0, -.3678794411714423215955238d0, &
        -.4001081341403160736400280d0, -.4234401367904400766628734d0, -.4383403499032471637408907d0, &
        -.4454241863223889026399290d0, -.4454241976960828728637340d0, -.4391564671033144569589568d0, &
        -.4274880540708223266513326d0, -.4113065890894513887520768d0, -.3914928958756679769706131d0, &
        -.3688972859665251787412620d0, -.3443199355303629399446828d0, -.3184955306263949534807185d0, &
        -.2920821644962502188874669d0, -.2656542962828890681640534d0, -.2396994397177897912204020d0, &
        -.2146181451424491640939456d0, -.1907267687784773058932939d0, -.1682624875086995569546816d0, &
        -.1473900121018631148986771d0, -.1282094722211392620560261d0, -.1107649874577763082733483d0, &
        -.9505349453993480902150559d-1, -.8103346641770551054241192d-1, -.6863322916783106348475741d-1, &
        -.5775865327580743751389419d-1, -.4830006328783957980109026d-1, -.4013827136320013258889535d-1, &
        -.3314969401563551466825700d-1, -.2721055620979549646261829d-1, -.2220022256661865628545539d-1, &
        -.1800372189840480267502263d-1, -.1451354925728548119815172d-1, -.1163084007733763911929080d-1, &
        -.9266014956431594449373699d-2, -.7338992385437093554928018d-2, -.5779061516816548137194317d-2, &
        -.4524499030007499171731476d-2, -.3522004336456824141111923d-2, -.2726016661692386541868837d-2, &
        -.2097966669473552341459824d-2, -.1605504811757694087682580d-2, -.1221738898797218035679319d-2, &
        -.9245047462622340271825711d-3, -.6956863110190540254524861d-3, -.5205955169809141905659767d-3, &
        -.3874169656489197360292113d-3, -.2867188376814953929994613d-3, -.2110284027525126746959732d-3, &
        -.1544685271976339753833504d-3, -.1124502587150317136058296d-3, -.8141583451940456365639560d-4, &
        -.5862617398424354123250055d-4, -.4198696356554642675724513d-4, -.2990772192017133390000897d-4, &
        -.2118866502002593128272052d-4, -.1493070967418717996705171d-4, -.1046450930688891587354327d-4, &
        -.7294971485088477169986746d-5, -.5058237141326785665552064d-5, -.3488590416297032549927031d-5, &
        -.2393206427093938070506012d-5, -.1633028318374209170743394d-5, -.1108394815502115127316820d-5, &
        -.7483179321690142728739359d-6, -.5025418723896900527555212d-6, -.3357037469306895805115546d-6, &
        -.2230700306981556484079346d-6, -.1474451577404705893471723d-6, -.9694537142843821183145493d-7, &
        -.6340650817983165854183039d-7, -.4125281597997292543454039d-7, -.2669863608647444234432417d-7, &
        -.1718869397329539903528673d-7, -.1100823095953252158935162d-7, -.7013187829205346730804204d-8, &
        -.4444665113656971914920979d-8, -.2802144497835918309456751d-8, -.1757406038399392007880848d-8, &
        -.1096442676719878283524089d-8, -.6805092493832370091384262d-9, -.4201635819811978308984480d-9, &
        -.2580720549398903308510481d-9, -.1576898051707325645824557d-9, -.9585353270320148521118371d-10, &
        -.5796372027032496381736661d-10, -.3486981951439767325186431d-10, -.2086844614201629359434107d-10, &
        -.1242450483517188985330601d-10, -.7358989436838238028175315d-11, -.4336195837012716989509190d-11, &
        -.2541866144559293225048769d-11, -.1482350707216456169596291d-11, -.8600132295160969048704279d-12, &
        -.4963825648030345884941720d-12, -.2850272799994640993351100d-12, -.1628231410435433343915847d-12, &
        -.9253517530796568988711767d-13, -.5231904387078439423734991d-13, -.2942904274907536637035087d-13, &
        -.1646861209472934265701707d-13, -.9168609972068950589419375d-14, -.5078280768842531755862938d-14, &
        -.2798321959684086361623925d-14, -.1534077985990025530178263d-14, -.8366946223931157801875458d-15, &
        -.4540014839572489640421670d-15, -.2450864324006565520585709d-15, -.1316297011679965318337360d-15, &
        -.7033347094398993022030766d-16, -.3738906588834781501200156d-16, -.1977436055729519304364136d-16, &
        -.1040486355537857239908506d-16, -.5446873085247993592442947d-17, -.2836846572016980047452363d-17, &
        -.1469951297806504842876013d-17, -.7577907726628295065637298d-18, -.3886652327556223671914838d-18, &
        -.1983274447591697794634031d-18, -.1006865346010664339728430d-18, -.5085599093462560019056651d-19, &
        -.2555616473221360979839205d-19, -.1277711291477349028381922d-19, -.6355561617974547678564100d-20, &
        -.3145284379748115775839534d-20, -.1548642984144385532194339d-20, -.7586277364385535380007560d-21, &
        -.3697368508385495481212434d-21, -.1792850002167444277197814d-21, -.8649339487208141711410640d-22, &
        -.4151549880751819128657313d-22, -.1982560526365887292005855d-22, -.9419591402219956768405243d-23, &
        -.4452742857507067242031201d-23, -.2094178149147388017585982d-23, -.9799199383965174477667876d-24, &
        -.4562039303075778937781093d-24, -.2113096807073358619927786d-24, -.9738054125666016460529380d-25, &
        -.4464962955517461045769742d-25, -.2036839830996770073279630d-25, -.9244633325579509781433326d-26, &
        -.4174617922924968276183391d-26, -.1875592296561359766067593d-26, -.8384076547424474404764890d-27, &
        -.3728786627489159285725893d-27, -.1649968834419055881014869d-27, -.7264074023243377877657008d-28, &
        -.3181863066343386789136187d-28, -.1386691329625598948075213d-28, -.6012783734099460236172624d-29, &
        -.2593995437123362612886143d-29, -.1113425178718492778355866d-29, -.4755009983792073461050496d-30, &
        -.2020415749389589696795519d-30, -.8541405110545145479519840d-31, -.3592671419230207088768861d-31, &
        -.1503507555679300913224246d-31, -.6260283436716785719346509d-32, -.2593480377514370417261009d-32, &
        -.1068988029132498238513063d-32, -.4383933266292682172809914d-33, -.1788778436796033153181937d-33, &
        -.7261912176216306101089190d-34, -.2933239704874698217172402d-34, -.1178817380216022663848294d-34, &
        -.4713550938665925243747415d-35, -.1875222736937308593811831d-35, -.7422680608185535408905020d-36, &
        -.2923292133270549875473422d-36, -.1145479868926911875642964d-36, -.4465877102072613609496200d-37, &
        -.1732329082290364039482100d-37, -.6685880402092324407358875d-38, -.2567388790315000103954881d-38, &
        -.9809113395522088573556313d-39, -.3728835208268407801110216d-39, -.1410334685901388337197457d-39, &
        -.5307340860010760817486761d-40, -.1987182729569070557023125d-40, -.7402951192281463566289795d-41, &
        -.2743964271316156357722060d-41]

   real(kind=wp), parameter :: h3(202) = [&
        -.7522527780636750492641059d0, -.7447490315497708463240858d0, -.7224619689626252165385118d0, &
        -.6860552061846493969863268d0, -.6366054955061156295204758d0, -.5755603365344096850483262d0, &
        -.5046815829547811446478382d0, -.4259777864640005624125117d0, -.3416285184773921405216660d0, &
        -.2539042236274465364534081d0, -.1650852727968867264939651d0, -.7738379667939842709258988d-1, &
        .7128394424195324853014844d-2, .8658293927736663174097951d-1, .1593668102410841966827594d0, &
        .2241613263920280449352809d0, .2799673824845877680517527d0, .3261167006652041288605015d0, &
        .3622695948610319801705815d0, .3884003473857446343896496d0, .4047718038942624860766923d0, &
        .4119011753186058824533937d0, .4105192820995319949018743d0, .4015255845130582620257648d0, &
        .3859413195031716183649201d0, .3648629230000597762360636d0, .3394176769351978836202936d0, &
        .3107232057693364099667621d0, .2798520840662402744643034d0, .2478024303401173430156194d0, &
        .2154749773684402246897790d0, .1836567467116494732079552d0, .1530111326375332319918793d0, &
        .1240739307148443832620940d0, .9725463688468146271051371d-1, .7284219701173870412977577d-1, &
        .5101430368585303674221369d-1, .3184931174142700893159512d-1, .1533986919450959655382290d-1, &
        .1407426811309193306581366d-2, -.1008311291608286074413380d-1, -.1930922840812282398312132d-1, &
        -.2647758532035030682089135d-1, -.3181217775839225922486926d-1, -.3554404023046894464526427d-1, &
        -.3790265208183702749516685d-1, -.3910905737306063850349279d-1, -.3937064210715186736633504d-1, &
        -.3887744829978686271653342d-1, -.3779986028416367095012508d-1, -.3628747152011772566083547d-1, &
        -.3446892799961155950489723d-1, -.3245254463375208029954651d-1, -.3032750110251363953076864d-1, &
        -.2816544089164076874994184d-1, -.2602231914851994604543481d-1, -.2394036936359898584929537d-1, &
        -.2195008388641825247433045d-1, -.2007212746338689903391700d-1, -.1831912527214265469865516d-1, &
        -.1669728661861120572688442d-1, -.1520784216814043766189564d-1, -.1384828617477219420839203d-1, &
        -.1261342573197174928239427d-1, -.1149624682246302216128454d-1, -.1048861222035593117850278d-1, &
        -.9581809474549548274726564d-2, -.8766968673914992518412266d-2, -.8035369845963356580758239d-2, &
        -.7378659024311709843220737d-2, -.6788990545369120409265684d-2, -.6259111260511144290061333d-2, &
        -.5782400284632080908741386d-2, -.5352875804464578036313191d-2, -.4965178455311671875710459d-2, &
        -.4614538919616485527188256d-2, -.4296735750484013517713710d-2, -.4008047998562558651176877d-2, &
        -.3745206023826233664801882d-2, -.3505342894046476979204381d-2, -.3285947990022833548498951d-2, &
        -.3084823830238963251792028d-2, -.2900046668982056656687612d-2, -.2729931086807768375811907d-2, &
        -.2572998556853316466871207d-2, -.2427949813646523181953355d-2, -.2293640754330915732383722d-2, &
        -.2169061550185197106672818d-2, -.2053318626361484792588433d-2, -.1945619169898585865047079d-2, &
        -.1845257842557062274985012d-2, -.1751605400071271234291063d-2, -.1664098948801722796139379d-2, &
        -.1582233601544145935191528d-2, -.1505555324435757496173641d-2, -.1433654795260900326865144d-2, &
        -.1366162119305863305428748d-2, -.1302742271937752484738341d-2, -.1243091157235637593921277d-2, &
        -.1186932189400779713774489d-2, -.1134013318531012910469058d-2, -.1084104434925714219487149d-2, &
        -.1036995096671516116549004d-2, -.9924925341187004927105684d-3, -.9504198922493585737226438d-3, &
        -.9106146780909950790852145d-3, -.8729273854455090856168734d-3, -.8372202734577421999252958d-3, &
        -.8033662790881490171689315d-3, -.7712480465049772662387464d-3, -.7407570588761368843162862d-3, &
        -.7117928601052224681383490d-3, -.6842623557902678206459998d-3, -.6580791841453911032352388d-3, &
        -.6331631488616646148452257d-3, -.6094397069328185150662371d-3, -.5868395053652243037188589d-3, &
        -.5652979614557357816469240d-3, -.5447548819764808379193485d-3, -.5251541171699206704315699d-3, &
        -.5064432459446979814905582d-3, -.4885732890847829717111949d-3, -.4714984476509869340551945d-3, &
        -.4551758640732029088500233d-3, -.4395654037105695480727411d-3, -.4246294549008608587718018d-3, &
        -.4103327457346023732872108d-3, -.3966421759777806984761265d-3, -.3835266627330082944382909d-3, &
        -.3709569985755748701109446d-3, -.3589057210304776810509891d-3, -.3473469923714317173865229d-3, &
        -.3362564888248703524021643d-3, -.3256112983526542094353014d-3, -.3153898262679901745636708d-3, &
        -.3055717080111181576022737d-3, -.2961377284756872027881530d-3, -.2870697473343167903391904d-3, &
        -.2783506298634098374691914d-3, -.2699641828135376810549337d-3, -.2618950949132550960609061d-3, &
        -.2541288816315519571599965d-3, -.2466518338577700959600751d-3, -.2394509701881161861915701d-3, &
        -.2325139925352426415436720d-3, -.2258292448020649292499711d-3, -.2193856743833149971866920d-3, &
        -.2131727962785441468085678d-3, -.2071806596186039850962257d-3, -.2013998164242456949121338d-3, &
        -.1958212924305587453675523d-3, -.1904365598246742268269672d-3, -.1852375117566223449189077d-3, &
        -.1802164384945805472907308d-3, -.1753660051060874920343825d-3, -.1706792305562262391906103d-3, &
        -.1661494681223850440721571d-3, -.1617703870330642541013594d-3, -.1575359552453832883093564d-3, &
        -.1534404232825155716084045d-3, -.1494783090582982775062280d-3, -.1456443836217787948749789d-3, &
        -.1419336577595168918308957d-3, -.1383413693981019940302776d-3, -.1348629717536061671270311d-3, &
        -.1314941221786090162018978d-3, -.1282306716610312631043834d-3, -.1250686549323268134999138d-3, &
        -.1220042811456336331711188d-3, -.1190339250872943430156140d-3, -.1161541188877486230913414d-3, &
        -.1133615442001899065679247d-3, -.1106530248175853517419676d-3, -.1080255197006960803598953d-3, &
        -.1054761163916181391183883d-3, -.1030020247891063146774180d-3, -.1006005712635544029343839d-3, &
        -.9826919309099737327798045d-4, -.9600543318688272806740460d-4, -.9380693512163903486436983d-4, &
        -.9167143840125715403094134d-4, -.8959677399720145006388879d-4, -.8758086011099098595144745d-4, &
        -.8562169815974051700802759d-4, -.8371736896983366064768422d-4, -.8186602916672109476829247d-4, &
        -.8006590774959976520266573d-4, -.7831530284043921555152064d-4, -.7661257859748228262605498d-4, &
        -.7495616228396319961002592d-4, -.7334454148335998246272097d-4, -.7177626145303295708079228d-4, &
        -.7024992260860025649833230d-4, -.6876417813186671874001603d-4, -.6731773169555726054493046d-4, &
        -.6590933529851172806481185d-4, -.6453778720537748581672358d-4, -.6320192998519050404738797d-4, &
        -.6190064864356719221383246d-4, -.6063286884353932444622322d-4, -.5939755521035460581086281d-4, &
        -.5819370971583712468698264d-4]
   !---------------------
   v=vin
   ! Voigt function is symmetric, so -v = v
   if (v < 0.0d0) v = -v

   ! if a is exactly zero go to 3 for exact expression
   if (a == 0.d0) then
      voigt = dexp(-(v*v))   
      return
   endif

   ! Scale up v for ease with lookup tables
   v0 = v*10.d0
   n  = int(v0)

   ! If u < 10, go to 1. Otherwise use asymptotic expression.
   if (n >= 100) then
      r=1/(v*v)
      voigt=a*r*oneonsqrtpi*(1.d0 + r*(1.5d0 + r*(3.75d0 + r*(13.125d0 + 59.0625d0*r))) - a*a*r*(1.d0 + r*(5.d0 +26.25d0*r)))
      return
   ! Arrive here if v < 10
   else
      !--seon (2018-02-08), this modification make it slightly faster than the original.
      !--seon v0 = 2*v*10.d0
      v2 = 2*v*10.d0
      ! Scale up v again by 2, then find closet integer.
      ! This gives the index for the lookup table array.
      !--seon n = int(v0)
      n = int(v2)
      ! v1 = dble(n)
      ! Add one to the integer value because Fortran arrays are unit offset.
      ! Then find the next two array indices.
      p  = n  + 1
      !--seon p1 = p  + 1
      !--seon p2 = p1 + 1
      p1 = n  + 2
      p2 = n  + 3
      ! Calculate the abcissa values associated with each entry in the lookup table.
      !--seon x  = (dble(p)-1)*0.5d0
      x  = dble(n)*0.5d0
      y  = x + 0.5d0
      !--seon z  = y + 0.5d0
      z  = x + 1.0d0
      ! Now rescale v0 back by 1/2
      !--seon v0 = 0.5d0*v0
      ! Use optimised Lagrange classical interpolation formula for
      ! a quadratic. Interpolation is done three times, for h0, h1 and h2.
      ! As the absicssa points are equally spaced the result has 
      ! been factored further.
      voigt = 2.d0*(  &
                      (v0-y)*(v0-z)*(h0(p)+a*(h1(p)+a*(h2(p)+a*h3(p)))) &
                     -(v0-x)*(v0-z)*2.d0*(h0(p1) + a*(h1(p1)+a*(h2(p1)+a*h3(p1)))) &
                     +(v0-x)*(v0-y)*(h0(p2) + a*(h1(p2)+a*(h2(p2)+a*h3(p2)))) &
                   )
   endif
   return
   end function voigt_king

   !--------------------------------------------------------
   ! See Tasitsiomi (2006) & Laurseon et al. (2009)
   ! This is a good approximation to better than 1% for temperatures T > 2K. (N. Gnedin 2005?)
   ! However, this causes error as higher as 10%, compared to those obtained using king or AQ1.
   function voigt_gnedin(x,a) result(app)
   use define
   implicit none
   real(kind=wp), intent(in) :: x,a
   real(kind=wp) :: zeta, ppi, q, x2
   real(kind=wp) :: app
   real(kind=wp), parameter :: sqrt_PI = sqrt(PI)
   x2   = x*x
   zeta = (x2 - 0.855_wp)/(x2 + 3.42_wp)
   app  = exp(-x2)
   if (zeta > 0.0_wp) then
      ppi = (((5.674_wp*zeta - 9.207_wp) * zeta + 4.421_wp) * zeta + 0.1117_wp) * zeta
      q   = (1.0_wp + 21.0_wp/x2)*a/(PI*(x2+1.0_wp)) * ppi
      app = q*sqrt_PI + app
   endif
   end function voigt_gnedin

   !-----------------------------
   !--- The arrays "coeff" in AQ1 and AQ2 have numerical errors.
   !--- But, no signnificant difference is obtained. (note added, K.I. Seon, 2019-12-22).
   function voigt_AQ2(x,y) result(VF)
   !
   ! x = (nu - nu0)/Doppler_width
   ! y = Voigt parameter (A21/4pi/Doppler_frequency_width)
   !     A21 = damping constant
   !----------------------------------------------------------------------
   ! 2017-07-21, Translated to Fortran by Kwang-il Seon
   !             Korea Astronomy and Space Science Institute (KASI)
   !             Original Matlab code taken from Abrarov & Quine (2015),
   !                               Journal of Mathematics Research, 7, 163
   !----------------------------------------------------------------------
   ! This function file is a subroutine for computation of the Voigt function.
   ! The input parameter y is used by absolute value according to the
   ! procedure described in the article. The parameter opt is either 1 for
   ! more accurate or 2 for more rapid computation. At y < 0 change the sign
   ! to negative externally, out of the body of this function file.
   !
   ! NOTE: This program completely covers the domain 0 < x < 40,000 and
   ! 10ˆ-4 < y < 10ˆ2 required for applications using the HITRAN molecular
   ! spectroscopic database. However, it may be implemented only to cover the
   ! smaller domain 0 <= x <= 15 and 10ˆ-6 <= y <= 15 that is the most
   ! difficult for rapid and accurate computation. See the article that
   ! briefly describes how other domains can be covered.
   !
   ! The code is written by Sanjar M. Abrarov and Brendan M. Quine, York
   ! University, Canada, March 2015.
   !----------------------------------------------------------------------
   use, intrinsic :: iso_fortran_env, only: real32, real64, int32, int64
   use define, only: wp
   implicit none
   real(kind=wp), intent(in) :: x,y
   real(kind=real64) :: VF
   
   real(kind=real64), parameter :: coeff(3,12) = reshape([ &
     2.307372754308023d-001, 4.989787261063716d-002,  1.464495070025765d+000, &
     7.760531995854886d-001, 4.490808534957343d-001, -3.230894193031240d-001, &
     4.235506885098250d-002, 1.247446815265929d+000, -5.397724160374686d-001, &
    -2.340509255269456d-001, 2.444995757921221d+000, -6.547649406082363d-002, &
    -4.557204758971222d-002, 4.041727681461610d+000,  2.411056013969393d-002, &
     5.043797125559205d-003, 6.037642585887094d+000,  4.001198804719684d-003, &
     1.180179737805654d-003, 8.432740471197681d+000, -5.387428751666454d-005, &
     1.754770213650354d-005, 1.122702133739336d+001, -2.451992671326258d-005, &
    -3.325020499631893d-006, 1.442048518447414d+001, -5.400164289522879d-007, &
    -9.375402319079375d-008, 1.801313201244001d+001,  1.771556420016014d-008, &
     8.034651067438904d-010, 2.200496182129099d+001,  4.940360170163906d-010, &
     3.355455275373310d-011, 2.639597461102705d+001,  5.674096644030151d-014], [3,12])
   integer,           parameter :: mMax     = size(coeff,2)  ! number of summation terms
   real(kind=real64), parameter :: varsigma = 1.375_real64   ! define the shift constant = 2.75/2
   real(kind=real64) :: x2, y1, y2, arr1, arr2
   integer :: m
   
   !*************************************************************************
   y1   = abs(y) + varsigma
   y2   = y1*y1
   x2   = x*x
   arr1 = y2 - x2    ! define 1st repeating array
   arr2 = x2 + y2    ! define 2nd repeating array
   VF   = 0.0_real64 ! initiate VF
   do m = 1, mMax
      VF = VF + (coeff(1,m)*(coeff(2,m) + arr1) + coeff(3,m)*y1*(coeff(2,m) + arr2))/ &
                (coeff(2,m)**2 + 2.0_real64*coeff(2,m)*arr1 + arr2*arr2)
   enddo
   end function voigt_AQ2

   !-----------------------------
   function voigt_AQ1(x,y) result(VF)
   !
   ! x = (nu - nu0)/Doppler_width
   ! y = Voigt parameter (A21/4pi/Doppler_frequency_width)
   !     A21 = damping constant
   !----------------------------------------------------------------------
   ! 2017-07-21, Translated to Fortran by Kwang-il Seon
   !             Korea Astronomy and Space Science Institute (KASI)
   !             Original Matlab code taken from Abrarov & Quine (2015),
   !                               Journal of Mathematics Research, 7, 163
   !----------------------------------------------------------------------
   ! This function file is a subroutine for computation of the Voigt function.
   ! The input parameter y is used by absolute value according to the
   ! procedure described in the article. The parameter opt is either 1 for
   ! more accurate or 2 for more rapid computation. At y < 0 change the sign
   ! to negative externally, out of the body of this function file.
   !
   ! NOTE: This program completely covers the domain 0 < x < 40,000 and
   ! 10ˆ-4 < y < 10ˆ2 required for applications using the HITRAN molecular
   ! spectroscopic database. However, it may be implemented only to cover the
   ! smaller domain 0 <= x <= 15 and 10ˆ-6 <= y <= 15 that is the most
   ! difficult for rapid and accurate computation. See the article that
   ! briefly describes how other domains can be covered.
   !
   ! The code is written by Sanjar M. Abrarov and Brendan M. Quine, York
   ! University, Canada, March 2015.
   !----------------------------------------------------------------------
   use, intrinsic :: iso_fortran_env, only: real32, real64, int32, int64
   use define, only: wp
   implicit none
   real(kind=wp), intent(in) :: x,y
   real(kind=real64) :: VF
   
   ! Define array of coefficients as coeff = [alpha;beta;gamma]
   real(kind=real64), parameter :: coeff(3,16) = reshape([ &
     1.608290174437121d-001, 3.855314219175531d-002,  1.366578214428949d+000, &
     6.885967427017463d-001, 3.469782797257978d-001, -5.742919588559361d-002, &
     2.651151642675390d-001, 9.638285547938826d-001, -5.709602545656873d-001, &
    -2.050008245317253d-001, 1.889103967396010d+000, -2.011075414803758d-001, &
    -1.274551644219086d-001, 3.122804517532180d+000,  1.069871368716704d-002, &
    -1.134971805306579d-002, 4.664930205202391d+000,  1.468639542320982d-002, &
     4.201921570328543d-003, 6.515481030406647d+000,  1.816268776500938d-003, &
     8.084740485193432d-004, 8.674456993144942d+000, -6.875907999947567d-005, &
     1.946391440605860d-005, 1.114185809341728d+001, -2.327910355924500d-005, &
    -4.132639863292073d-006, 1.391768433122366d+001, -1.004011418729134d-006, &
    -2.656262492217795d-007, 1.700193570656409d+001,  2.304990232059197d-008, &
    -1.524188131553777d-009, 2.039461221943855d+001,  2.275276345355270d-009, &
     2.239681784892829d-010, 2.409571386984707d+001,  3.383885053101652d-011, &
     4.939143128687883d-012, 2.810524065778962d+001, -4.398940326332977d-013, &
     4.692078138494072d-015, 3.242319258326621d+001, -1.405511706545786d-014, &
    -2.512454984032184d-016, 3.704956964627684d+001, -3.954682293307548d-016], &
    [3,16])
   integer,           parameter :: mMax     = size(coeff,2)  ! number of summation terms
   real(kind=real64), parameter :: varsigma = 1.375_real64   ! define the shift constant = 2.75/2
   real(kind=real64) :: x2, y1, y2, arr1, arr2
   integer :: m
   
   !*************************************************************************
   y1   = abs(y) + varsigma
   y2   = y1*y1
   x2   = x*x
   arr1 = y2 - x2    ! define 1st repeating array
   arr2 = x2 + y2    ! define 2nd repeating array
   VF   = 0.0_real64 ! initiate VF
   do m = 1, mMax
      VF = VF + (coeff(1,m)*(coeff(2,m) + arr1) + coeff(3,m)*y1*(coeff(2,m) + arr2))/ &
                (coeff(2,m)**2 + 2.0_real64*coeff(2,m)*arr1 + arr2*arr2)
   enddo
   end function voigt_AQ1
   !*************************************************************************
   !--- Algorithm developed by K.I. Seon (2019-12-22)
   function voigt_seon2(vin,a) result(voigt)
   use define, only : wp
   implicit none
   real(kind=wp), intent(in) :: a,vin
   real(kind=wp) :: voigt
   !----
   ! Seon, K.I. 2019-12-22
   ! inspired by Harris 1948, ApJ, 108, 112, and voigt_king, but adjusted for accuracy and speed.
   !----

   real(kind=wp) :: v, vv, v2, y1, y2, y3, a2
   integer       :: k1,k2,k3
   !---------------------
   real(kind=wp), parameter :: PI         = 3.1415926535897932385d0
   real(kind=wp), parameter :: one_sqrtPI = 0.56418958354775628695d0
   !---------------------
   real(wp), parameter :: u(202) = [ &
       0.00d+00, 1.00d+00, 2.00d+00, 3.00d+00, 4.00d+00, 5.00d+00, 6.00d+00, 7.00d+00, 8.00d+00, 9.00d+00, 1.00d+01, &
       1.10d+01, 1.20d+01, 1.30d+01, 1.40d+01, 1.50d+01, 1.60d+01, 1.70d+01, 1.80d+01, 1.90d+01, 2.00d+01, 2.10d+01, &
       2.20d+01, 2.30d+01, 2.40d+01, 2.50d+01, 2.60d+01, 2.70d+01, 2.80d+01, 2.90d+01, 3.00d+01, 3.10d+01, 3.20d+01, &
       3.30d+01, 3.40d+01, 3.50d+01, 3.60d+01, 3.70d+01, 3.80d+01, 3.90d+01, 4.00d+01, 4.10d+01, 4.20d+01, 4.30d+01, &
       4.40d+01, 4.50d+01, 4.60d+01, 4.70d+01, 4.80d+01, 4.90d+01, 5.00d+01, 5.10d+01, 5.20d+01, 5.30d+01, 5.40d+01, &
       5.50d+01, 5.60d+01, 5.70d+01, 5.80d+01, 5.90d+01, 6.00d+01, 6.10d+01, 6.20d+01, 6.30d+01, 6.40d+01, 6.50d+01, &
       6.60d+01, 6.70d+01, 6.80d+01, 6.90d+01, 7.00d+01, 7.10d+01, 7.20d+01, 7.30d+01, 7.40d+01, 7.50d+01, 7.60d+01, &
       7.70d+01, 7.80d+01, 7.90d+01, 8.00d+01, 8.10d+01, 8.20d+01, 8.30d+01, 8.40d+01, 8.50d+01, 8.60d+01, 8.70d+01, &
       8.80d+01, 8.90d+01, 9.00d+01, 9.10d+01, 9.20d+01, 9.30d+01, 9.40d+01, 9.50d+01, 9.60d+01, 9.70d+01, 9.80d+01, &
       9.90d+01, 1.00d+02, 1.01d+02, 1.02d+02, 1.03d+02, 1.04d+02, 1.05d+02, 1.06d+02, 1.07d+02, 1.08d+02, 1.09d+02, &
       1.10d+02, 1.11d+02, 1.12d+02, 1.13d+02, 1.14d+02, 1.15d+02, 1.16d+02, 1.17d+02, 1.18d+02, 1.19d+02, 1.20d+02, &
       1.21d+02, 1.22d+02, 1.23d+02, 1.24d+02, 1.25d+02, 1.26d+02, 1.27d+02, 1.28d+02, 1.29d+02, 1.30d+02, 1.31d+02, &
       1.32d+02, 1.33d+02, 1.34d+02, 1.35d+02, 1.36d+02, 1.37d+02, 1.38d+02, 1.39d+02, 1.40d+02, 1.41d+02, 1.42d+02, &
       1.43d+02, 1.44d+02, 1.45d+02, 1.46d+02, 1.47d+02, 1.48d+02, 1.49d+02, 1.50d+02, 1.51d+02, 1.52d+02, 1.53d+02, &
       1.54d+02, 1.55d+02, 1.56d+02, 1.57d+02, 1.58d+02, 1.59d+02, 1.60d+02, 1.61d+02, 1.62d+02, 1.63d+02, 1.64d+02, &
       1.65d+02, 1.66d+02, 1.67d+02, 1.68d+02, 1.69d+02, 1.70d+02, 1.71d+02, 1.72d+02, 1.73d+02, 1.74d+02, 1.75d+02, &
       1.76d+02, 1.77d+02, 1.78d+02, 1.79d+02, 1.80d+02, 1.81d+02, 1.82d+02, 1.83d+02, 1.84d+02, 1.85d+02, 1.86d+02, &
       1.87d+02, 1.88d+02, 1.89d+02, 1.90d+02, 1.91d+02, 1.92d+02, 1.93d+02, 1.94d+02, 1.95d+02, 1.96d+02, 1.97d+02, &
       1.98d+02, 1.99d+02, 2.00d+02, 2.01d+02]
   real(wp), parameter :: h0(101) = [ &
       1.0000000000d+00,  9.9750312240d-01,  9.9004983375d-01,  9.7775123719d-01,  9.6078943915d-01,  9.3941306281d-01, &
       9.1393118527d-01,  8.8470590494d-01,  8.5214378897d-01,  8.1668648260d-01,  7.7880078307d-01,  7.3896848826d-01, &
       6.9767632607d-01,  6.5540625433d-01,  6.1262639418d-01,  5.6978282473d-01,  5.2729242404d-01,  4.8553689515d-01, &
       4.4485806622d-01,  4.0555450506d-01,  3.6787944117d-01,  3.3203994534d-01,  2.9819727943d-01,  2.6646829781d-01, &
       2.3692775868d-01,  2.0961138715d-01,  1.8451952399d-01,  1.6162119247d-01,  1.4085842092d-01,  1.2215066954d-01, &
       1.0539922456d-01,  9.0491441664d-02,  7.7304740443d-02,  6.5710273228d-02,  5.5576212611d-02,  4.6770622384d-02, &
       3.9163895099d-02,  3.2630755993d-02,  2.7051846866d-02,  2.2314914777d-02,  1.8315638889d-02,  1.4958134701d-02, &
       1.2155178330d-02,  9.8281948354d-03,  7.9070540516d-03,  6.3297154275d-03,  5.0417602597d-03,  3.9958458301d-03, &
       3.1511115984d-03,  2.4725630359d-03,  1.9304541362d-03,  1.4996852893d-03,  1.1592291739d-03,  8.9159372000d-04, &
       6.8232805276d-04,  5.1957468215d-04,  3.9366904066d-04,  2.9678576779d-04,  2.2262985692d-04,  1.6616986661d-04, &
       1.2340980409d-04,  9.1195956362d-05,  6.7054824303d-05,  4.9058357456d-05,  3.5712849642d-05,  2.5868100223d-05, &
       1.8643742332d-05,  1.3369962121d-05,  9.5401628731d-06,  6.7734499977d-06,  4.7851173921d-06,  3.3635957248d-06, &
       2.3525752000d-06,  1.6372378072d-06,  1.1337271387d-06,  7.8114894083d-07,  5.3553478028d-07,  3.6531713412d-07, &
       2.4795960180d-07,  1.6746357031d-07,  1.1253517472d-07,  7.5246232576d-08,  5.0062180208d-08,  3.3140822709d-08, &
       2.1829577951d-08,  1.4307241919d-08,  9.3302875745d-09,  6.0542822825d-09,  3.9089384343d-09,  2.5112128333d-09, &
       1.6052280552d-09,  1.0209829472d-09,  6.4614317731d-10,  4.0688114507d-10,  2.5493818804d-10,  1.5893910095d-10, &
       9.8595055760d-11,  6.0856651055d-11,  3.7375713279d-11,  2.2840176580d-11,  1.3887943865d-11]
   real(wp), parameter :: h1(202) = [ &
      -1.1283791671d+00, -1.1227466650d+00, -1.1059614342d+00, -1.0783569495d+00, -1.0404779636d+00, -9.9306440929d-01, &
      -9.3702975743d-01, -8.7343467386d-01, -8.0345698602d-01, -7.2835908978d-01, -6.4945399419d-01, -5.6807121383d-01, &
      -4.8552367712d-01, -4.0307672820d-01, -3.2192016652d-01, -2.4314410022d-01, -1.6771919747d-01, -9.6481713891d-02, &
      -3.0123465589d-02,  3.0813284570d-02,  8.5936244587d-02,  1.3499919353d-01,  1.7789427449d-01,  2.1464108857d-01, &
       2.4537326178d-01,  2.7032318476d-01,  2.8980562182d-01,  3.0420085238d-01,  3.1393795097d-01,  3.1947873533d-01, &
       3.2130282333d-01,  3.1989414236d-01,  3.1572913641d-01,  3.0926682002d-01,  3.0094073973d-01,  2.9115282434d-01, &
       2.8026903909d-01,  2.6861670530d-01,  2.5648330794d-01,  2.4411658777d-01,  2.3172570117d-01,  2.1948322892d-01, &
       2.0752782183d-01,  1.9596728589d-01,  1.8488192931d-01,  1.7432801731d-01,  1.6434120570d-01,  1.5493985002d-01, &
       1.4612811174d-01,  1.3789880599d-01,  1.3023595596d-01,  1.2311703659d-01,  1.1651490504d-01,  1.1039942693d-01, &
       1.0473881604d-01,  9.9500711302d-02,  9.4653018548d-02,  9.0164546527d-02,  8.6005466678d-02,  8.2147625332d-02, &
       7.8564735130d-02,  7.5232469952d-02,  7.2128484933d-02,  6.9232380189d-02,  6.6525624002d-02,  6.3991448483d-02, &
       6.1614728196d-02,  5.9381849993d-02,  5.7280580350d-02,  5.5299934831d-02,  5.3430052964d-02,  5.1662080652d-02, &
       4.9988061429d-02,  4.8400837154d-02,  4.6893958263d-02,  4.5461603337d-02,  4.4098507510d-02,  4.2799899084d-02, &
       4.1561443660d-02,  4.0379195028d-02,  3.9249552106d-02,  3.8169221224d-02,  3.7135183119d-02,  3.6144664028d-02, &
       3.5195110371d-02,  3.4284166537d-02,  3.3409655367d-02,  3.2569560963d-02,  3.1762013521d-02,  3.0985275908d-02, &
       3.0237731750d-02,  2.9517874842d-02,  2.8824299693d-02,  2.8155693077d-02,  2.7510826447d-02,  2.6888549115d-02, &
       2.6287782114d-02,  2.5707512633d-02,  2.5146788995d-02,  2.4604716089d-02,  2.4080451214d-02,  2.3573200300d-02, &
       2.3082214451d-02,  2.2606786786d-02,  2.2146249545d-02,  2.1699971437d-02,  2.1267355195d-02,  2.0847835338d-02, &
       2.0440876101d-02,  2.0045969528d-02,  1.9662633709d-02,  1.9290411154d-02,  1.8928867283d-02,  1.8577589032d-02, &
       1.8236183552d-02,  1.7904277009d-02,  1.7581513466d-02,  1.7267553839d-02,  1.6962074929d-02,  1.6664768519d-02, &
       1.6375340534d-02,  1.6093510248d-02,  1.5819009555d-02,  1.5551582279d-02,  1.5290983531d-02,  1.5036979108d-02, &
       1.4789344924d-02,  1.4547866490d-02,  1.4312338407d-02,  1.4082563906d-02,  1.3858354408d-02,  1.3639529111d-02, &
       1.3425914605d-02,  1.3217344502d-02,  1.3013659099d-02,  1.2814705046d-02,  1.2620335050d-02,  1.2430407577d-02, &
       1.2244786586d-02,  1.2063341271d-02,  1.1885945815d-02,  1.1712479163d-02,  1.1542824807d-02,  1.1376870573d-02, &
       1.1214508433d-02,  1.1055634319d-02,  1.0900147945d-02,  1.0747952644d-02,  1.0598955211d-02,  1.0453065752d-02, &
       1.0310197543d-02,  1.0170266896d-02,  1.0033193029d-02,  9.8988979474d-03,  9.7673063256d-03,  9.6383453984d-03, &
       9.5119448559d-03,  9.3880367438d-03,  9.2665553683d-03,  9.1474372057d-03,  9.0306208162d-03,  8.9160467615d-03, &
       8.8036575267d-03,  8.6933974447d-03,  8.5852126256d-03,  8.4790508880d-03,  8.3748616939d-03,  8.2725960868d-03, &
       8.1722066315d-03,  8.0736473579d-03,  7.9768737064d-03,  7.8818424757d-03,  7.7885117732d-03,  7.6968409673d-03, &
       7.6067906419d-03,  7.5183225523d-03,  7.4313995839d-03,  7.3459857117d-03,  7.2620459619d-03,  7.1795463751d-03, &
       7.0984539711d-03,  7.0187367147d-03,  6.9403634834d-03,  6.8633040359d-03,  6.7875289824d-03,  6.7130097557d-03, &
       6.6397185835d-03,  6.5676284617d-03,  6.4967131293d-03,  6.4269470435d-03,  6.3583053562d-03,  6.2907638911d-03, &
       6.2242991223d-03,  6.1588881532d-03,  6.0945086958d-03,  6.0311390520d-03,  5.9687580942d-03,  5.9073452479d-03, &
       5.8468804737d-03,  5.7873442512d-03,  5.7287175622d-03,  5.6709818759d-03]
   real(wp), parameter :: h2(101) = [ &
       1.0000000000d+00,  9.9251560679d-01,  9.7024883707d-01,  9.3375243152d-01,  8.8392628402d-01,  8.2198642996d-01, &
       7.4942357192d-01,  6.6795295823d-01,  5.7945777650d-01,  4.8592845715d-01,  3.8940039154d-01,  2.9189255286d-01, &
       1.9534937130d-01,  1.0158796942d-01,  1.2252527884d-02, -7.1222853091d-02, -1.4764187873d-01, -2.1606391834d-01, &
      -2.7581200106d-01, -3.2647137658d-01, -3.6787944117d-01, -4.0010813414d-01, -4.2344013679d-01, -4.3834034990d-01, &
      -4.4542418632d-01, -4.4542419770d-01, -4.3915646710d-01, -4.2748805407d-01, -4.1130658909d-01, -3.9149289588d-01, &
      -3.6889728597d-01, -3.4431993553d-01, -3.1849553063d-01, -2.9208216450d-01, -2.6565429628d-01, -2.3969943972d-01, &
      -2.1461814514d-01, -1.9072676878d-01, -1.6826248751d-01, -1.4739001210d-01, -1.2820947222d-01, -1.1076498746d-01, &
      -9.5053494540d-02, -8.1033466418d-02, -6.8633229168d-02, -5.7758653276d-02, -4.8300063288d-02, -4.0138271363d-02, &
      -3.3149694016d-02, -2.7210556210d-02, -2.2200222567d-02, -1.8003721898d-02, -1.4513549257d-02, -1.1630840077d-02, &
      -9.2660149564d-03, -7.3389923854d-03, -5.7790615168d-03, -4.5244990300d-03, -3.5220043365d-03, -2.7260166617d-03, &
      -2.0979666695d-03, -1.6055048118d-03, -1.2217388988d-03, -9.2450474626d-04, -6.9568631102d-04, -5.2059551698d-04, &
      -3.8741696565d-04, -2.8671883768d-04, -2.1102840275d-04, -1.5446852720d-04, -1.1245025872d-04, -8.1415834519d-05, &
      -5.8626173984d-05, -4.1986963566d-05, -2.9907721920d-05, -2.1188665020d-05, -1.4930709674d-05, -1.0464509307d-05, &
      -7.2949714851d-06, -5.0582371413d-06, -3.4885904163d-06, -2.3932064271d-06, -1.6330283184d-06, -1.1083948155d-06, &
      -7.4831793217d-07, -5.0254187239d-07, -3.3570374693d-07, -2.2307003070d-07, -1.4744515774d-07, -9.6945371428d-08, &
      -6.3406508180d-08, -4.1252815980d-08, -2.6698636086d-08, -1.7188693973d-08, -1.1008230960d-08, -7.0131878292d-09, &
      -4.4446651137d-09, -2.8021444978d-09, -1.7574060384d-09, -1.0964426767d-09, -6.8050924938d-10]
   real(wp), parameter :: h3(202) = [ &
      -7.5225277806d-01, -7.4474903155d-01, -7.2246196896d-01, -6.8605520618d-01, -6.3660549551d-01, -5.7556033653d-01, &
      -5.0468158295d-01, -4.2597778646d-01, -3.4162851848d-01, -2.5390422363d-01, -1.6508527280d-01, -7.7383796679d-02, &
       7.1283944242d-03,  8.6582939277d-02,  1.5936681024d-01,  2.2416132639d-01,  2.7996738248d-01,  3.2611670067d-01, &
       3.6226959486d-01,  3.8840034739d-01,  4.0477180389d-01,  4.1190117532d-01,  4.1051928210d-01,  4.0152558451d-01, &
       3.8594131950d-01,  3.6486292300d-01,  3.3941767694d-01,  3.1072320577d-01,  2.7985208407d-01,  2.4780243034d-01, &
       2.1547497737d-01,  1.8365674671d-01,  1.5301113264d-01,  1.2407393071d-01,  9.7254636885d-02,  7.2842197012d-02, &
       5.1014303686d-02,  3.1849311741d-02,  1.5339869195d-02,  1.4074268113d-03, -1.0083112916d-02, -1.9309228408d-02, &
      -2.6477585320d-02, -3.1812177758d-02, -3.5544040230d-02, -3.7902652082d-02, -3.9109057373d-02, -3.9370642107d-02, &
      -3.8877448300d-02, -3.7799860284d-02, -3.6287471520d-02, -3.4468928000d-02, -3.2452544634d-02, -3.0327501103d-02, &
      -2.8165440892d-02, -2.6022319149d-02, -2.3940369364d-02, -2.1950083886d-02, -2.0072127463d-02, -1.8319125272d-02, &
      -1.6697286619d-02, -1.5207842168d-02, -1.3848286175d-02, -1.2613425732d-02, -1.1496246822d-02, -1.0488612220d-02, &
      -9.5818094745d-03, -8.7669686739d-03, -8.0353698459d-03, -7.3786590243d-03, -6.7889905454d-03, -6.2591112605d-03, &
      -5.7824002846d-03, -5.3528758044d-03, -4.9651784553d-03, -4.6145389196d-03, -4.2967357505d-03, -4.0080479985d-03, &
      -3.7452060238d-03, -3.5053428940d-03, -3.2859479900d-03, -3.0848238302d-03, -2.9000466689d-03, -2.7299310868d-03, &
      -2.5729985568d-03, -2.4279498136d-03, -2.2936407543d-03, -2.1690615501d-03, -2.0533186263d-03, -1.9456191699d-03, &
      -1.8452578426d-03, -1.7516054001d-03, -1.6640989487d-03, -1.5822336015d-03, -1.5055553244d-03, -1.4336547953d-03, &
      -1.3661621192d-03, -1.3027422719d-03, -1.2430911571d-03, -1.1869321894d-03, -1.1340133185d-03, -1.0841044348d-03, &
      -1.0369950966d-03, -9.9249253404d-04, -9.5041989219d-04, -9.1061467809d-04, -8.7292738531d-04, -8.3722027334d-04, &
      -8.0336627901d-04, -7.7124804650d-04, -7.4075705887d-04, -7.1179285990d-04, -6.8426235565d-04, -6.5807918407d-04, &
      -6.3316314882d-04, -6.0943970693d-04, -5.8683950518d-04, -5.6529796136d-04, -5.4475488192d-04, -5.2515411708d-04, &
      -5.0644324595d-04, -4.8857328892d-04, -4.7149844743d-04, -4.5517586394d-04, -4.3956540358d-04, -4.2462945490d-04, &
      -4.1033274540d-04, -3.9664217583d-04, -3.8352666249d-04, -3.7095699861d-04, -3.5890572103d-04, -3.4734699205d-04, &
      -3.3625648853d-04, -3.2561129824d-04, -3.1538982625d-04, -3.0557170801d-04, -2.9613772817d-04, -2.8706974712d-04, &
      -2.7835062963d-04, -2.6996418274d-04, -2.6189509492d-04, -2.5412888136d-04, -2.4665183346d-04, -2.3945097011d-04, &
      -2.3251399241d-04, -2.2582924480d-04, -2.1938567386d-04, -2.1317279595d-04, -2.0718065941d-04, -2.0139981622d-04, &
      -1.9582129244d-04, -1.9043655932d-04, -1.8523751154d-04, -1.8021643815d-04, -1.7536600484d-04, -1.7067923056d-04, &
      -1.6614946764d-04, -1.6177038661d-04, -1.5753595508d-04, -1.5344042326d-04, -1.4947830905d-04, -1.4564438319d-04, &
      -1.4193365778d-04, -1.3834136943d-04, -1.3486297061d-04, -1.3149412218d-04, -1.2823067091d-04, -1.2506865511d-04, &
      -1.2200428102d-04, -1.1903392416d-04, -1.1615411888d-04, -1.1336154386d-04, -1.1065302515d-04, -1.0802551941d-04, &
      -1.0547611574d-04, -1.0300202479d-04, -1.0060057058d-04, -9.8269193605d-05, -9.6005432731d-05, -9.3806933922d-05, &
      -9.1671438406d-05, -8.9596772922d-05, -8.7580860834d-05, -8.5621697497d-05, -8.3717368057d-05, -8.1866029167d-05, &
      -8.0065907178d-05, -7.8315302884d-05, -7.6612577702d-05, -7.4956160740d-05, -7.3344541487d-05, -7.1776260464d-05, &
      -7.0249920898d-05, -6.8764177979d-05, -6.7317730471d-05, -6.5909335307d-05, -6.4537785740d-05, -6.3201928388d-05, &
      -6.1900648288d-05, -6.0632866943d-05, -5.9397555195d-05, -5.8193708824d-05]
   !---------------------
   ! Do not use abs function, which give rise to a numerical error.
   !v = abs(vin)
   if (vin < 0.d0) then
      v = -vin
   else
      v = vin
   endif
   if (v < 1.0d0) then
       vv = v*20.d0
       k1 = int(vv) + 1
       k2 = k1 + 1
       !--- Linear interpolation
       !--- the second-order is good enough.
       y1 = h0(k1) + a*(h1(k1) +  a*h2(k1))
       y2 = h0(k2) + a*(h1(k2) +  a*h2(k2))
       y3 = h0(k2) + a*(h1(k2) +  a*h2(k2))
       voigt = y1 + (y2-y1) * (vv - u(k1))
   else if (v < 5.0d0) then
       vv = v*20.d0
       !k1 = int(vv) + 1
       !-- the following option give a slightly better result. (2019-12-17)
       k1 = int(vv)
       k2 = k1 + 1
       k3 = k1 + 2
       !--- Quadratic interpolation (Lagrange interpolation)
       !--- a^4 term does not give a higher accuracy than a^3.
       !--- We need a^3 term to obtain results as accurate as voigt_king.
       y1 = h0(k1) + a*(h1(k1) + a*(h2(k1) + a*h3(k1)))
       y2 = h0(k2) + a*(h1(k2) + a*(h2(k2) + a*h3(k2)))
       y3 = h0(k3) + a*(h1(k3) + a*(h2(k3) + a*h3(k3)))
       !y1 = h0(k1) + a*(h1(k1) + a*h2(k1))
       !y2 = h0(k2) + a*(h1(k2) + a*h2(k2))
       !y3 = h0(k3) + a*(h1(k3) + a*h2(k3))
       voigt = 0.5d0*y1*(vv-u(k2))*(vv-u(k3)) - y2*(vv-u(k1))*(vv-u(k3)) + 0.5d0*y3*(vv-u(k1))*(vv-u(k2))
   else if (v < 10.0d0) then
       vv = v*20.d0
       k1 = int(vv) + 1
       k2 = k1 + 1
       a2 = a*a
       !--- Linear interpolation
       y1 = a*(h1(k1) + a2*h3(k1))
       y2 = a*(h1(k2) + a2*h3(k2))
       voigt = y1 + (y2-y1) * (vv - u(k1))
   else
       !--- Assymptotic solution, a and 1/v are assumed to be the same order of magnitude.
       v2    = 1d0/(v*v)
       voigt = one_sqrtPI * a * v2 * (1.0d0 + ((1.5d0-a*a) + 3.75d0*v2)*v2)
   endif
   return
   end function voigt_seon2
   !*************************************************************************
   ! Algorithm developed by Smith et al. (2015) MNRAS, 449, 4336
   function voigt_smith(v, a) result(voigt)
   use, intrinsic :: iso_fortran_env, only: real32, real64, int32, int64
   implicit none
   real(real64), intent(in) :: v,a
   real(real64) :: voigt
   real(real64), parameter :: aa(7) = [15.75328153963877d0, 286.9341762324778d0, 19.05706700907019d0, 28.22644017233441d0, &
                                        9.526399802414186d0, 35.29217026286130d0, 0.8681020834678775d0]
   real(real64), parameter :: bb(9) = [0.0003300469163682737d0, 0.5403095364583999d0, 2.676724102580895d0, 12.82026082606220d0, &
                                       3.21166435627278d0, 32.032981933420d0, 9.0328158696d0, 23.7489999060d0, 1.82106170570d0]
   real(real64), parameter :: one_sqrtPI = 0.56418958354775628695d0
   real(real64) :: z, r

   !--- The first rational approximation has a singularity at z = 0.869 (v = 0.932) (2019-12-22)
   !--- The sigularity may cause a severe problem.
   z = v*v
   if (z <= 3.0d0) then
      voigt = exp(-z)*(1.d0-a*(aa(1)+aa(2)/(z-aa(3) + aa(4)/(z-aa(5) + aa(6)/(z - aa(7))))))
   else if (z < 25.d0) then
      voigt = exp(-z) + a*(bb(1) + bb(2)/(z-bb(3) + bb(4)/(z+bb(5) + bb(6)/(z-bb(7) + bb(8)/(z-bb(9))))))
   else
      voigt = one_sqrtPI * a / (z-1.5d0 - 1.5d0/(z-3.5d0 - 5.d0/(z-5.5d0)))
   endif
   return
   end function voigt_smith
   !*************************************************************************
end module voigt_mod
